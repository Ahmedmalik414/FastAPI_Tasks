<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Students Collaboration Chat</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      padding: 12px 20px; /* Reduced from 20px */
      text-align: center;
      font-size: 24px; /* Reduced from 28px */
      font-weight: bold;
      color: #fff;
      background: var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #currentUser {
      font-size: 14px; /* Reduced from 16px */
      opacity: 0.9;
    }
    #themeSelector {
      padding: 4px; /* Reduced from 6px */
      border-radius: 6px; /* Reduced from 8px */
      border: none;
      font-size: 12px; /* Reduced from 14px */
    }
    #chat {
      flex: 1;
      padding: 12px; /* Reduced from 20px */
      overflow-y: auto;
      background: #fdfdfd;
      font-size: 16px; /* Reduced from 18px */
    }
    .msg {
      margin: 6px 0; /* Reduced from 12px 0 */
      padding: 8px 12px; /* Reduced from 12px 16px */
      border-radius: 12px; /* Reduced from 14px */
      max-width: 70%;
      line-height: 1.4; /* Reduced from 1.5 */
      word-wrap: break-word;
    }
    .msg.other {
      background: #ececec;
      color: #333;
      align-self: flex-start;
    }
    .msg.you {
      background: var(--primary);
      color: #fff;
      align-self: flex-end;
    }
    .msg b {
      display: block;
      margin-bottom: 2px; /* Reduced from 4px */
      font-size: 12px; /* Reduced from 14px */
      opacity: 0.8;
    }
    .input-area {
      display: flex;
      padding: 10px; /* Reduced from 15px */
      border-top: 1px solid #ddd; /* Reduced from 2px */
      background: #fff;
    }
    .input-area input {
      flex: 1;
      padding: 10px; /* Reduced from 12px */
      border: 1px solid #ccc;
      border-radius: 6px; /* Reduced from 8px */
      outline: none;
      margin-right: 8px; /* Reduced from 10px */
      font-size: 14px; /* Reduced from 16px */
    }
    .input-area button {
      padding: 10px 16px; /* Reduced from 12px 20px */
      border: none;
      border-radius: 6px; /* Reduced from 8px */
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      font-weight: bold;
      font-size: 14px; /* Reduced from 16px */
      transition: 0.3s;
    }
    .input-area button:hover {
      opacity: 0.9;
    }
    .file-upload {
      padding: 10px; /* Reduced from 15px */
      display: flex;
      align-items: center;
      border-top: 1px solid #ddd; /* Reduced from 2px */
      background: #fff;
    }
    .file-upload input {
      flex: 1;
      border: 1px solid #ccc;
      padding: 8px; /* Reduced from 10px */
      border-radius: 6px; /* Reduced from 8px */
      font-size: 14px; /* Reduced from 16px */
    }
    .file-upload button {
      margin-left: 8px; /* Reduced from 10px */
      padding: 8px 12px; /* Reduced from 10px 16px */
      border: none;
      border-radius: 6px; /* Reduced from 8px */
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      font-weight: bold;
      font-size: 14px; /* Reduced from 16px */
    }
    .file-actions {
      margin-top: 4px; /* Reduced from 8px */
    }
    .file-link, .download-btn {
      background: #ffb88c;
      color: #333;
      text-decoration: none;
      padding: 4px 8px; /* Reduced from 6px 12px */
      border-radius: 4px; /* Reduced from 6px */
      margin-right: 6px; /* Reduced from 8px */
      font-size: 12px; /* Reduced from 14px */
      transition: 0.3s;
      border: none;
      cursor: pointer;
    }
    .file-link:hover, .download-btn:hover {
      background: #ff9e73;
    }
    #loginArea {
      display: flex;
      padding: 15px; /* Reduced from 20px */
      border-bottom: 1px solid #ddd; /* Reduced from 2px */
      background: #fff3f0;
    }
    #loginArea input {
      flex: 1;
      padding: 10px; /* Reduced from 12px */
      border: 1px solid #ccc;
      border-radius: 6px; /* Reduced from 8px */
      margin-right: 8px; /* Reduced from 10px */
      font-size: 14px; /* Reduced from 16px */
    }
    #loginArea button {
      padding: 10px 16px; /* Reduced from 12px 20px */
      border: none;
      border-radius: 6px; /* Reduced from 8px */
      background: var(--primary);
      color: #fff;
      font-weight: bold;
      font-size: 14px; /* Reduced from 16px */
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div>💬 Students Chat</div>
      <div>
        <span id="currentUser"></span>
        <select id="themeSelector" onchange="changeTheme()">
          <option value="linear-gradient(135deg,#667eea,#764ba2)">Purple</option>
          <option value="linear-gradient(135deg,#ff7e5f,#feb47b)">Orange</option>
          <option value="linear-gradient(135deg,#43cea2,#185a9d)">Teal-Blue</option>
          <option value="linear-gradient(135deg,#f7971e,#ffd200)">Gold</option>
          <option value="linear-gradient(135deg,#6a11cb,#2575fc)">Indigo</option>
          <option value="linear-gradient(135deg,#ff4b1f,#1fddff)">Red-Cyan</option>
          <option value="linear-gradient(135deg,#00c6ff,#0072ff)">Sky Blue</option>
          <option value="linear-gradient(135deg,#11998e,#38ef7d)">Green</option>
          <option value="linear-gradient(135deg,#fc5c7d,#6a82fb)">Pink-Purple</option>
          <option value="linear-gradient(135deg,#ff9966,#ff5e62)">Peach-Red</option>
        </select>
      </div>
    </div>

    <!-- Login area -->
    <div id="loginArea">
      <input id="username" placeholder="Enter your name">
      <button onclick="connect()">Join</button>
    </div>

    <div id="chat"></div>

    <div class="input-area" id="messageArea" style="display:none;">
      <input id="message" placeholder="Type a message">
      <button onclick="sendMessage()">Send</button>
    </div>

    <div class="file-upload" id="fileArea" style="display:none;">
      <input type="file" id="fileInput">
      <button onclick="sendFile()">📂 Upload</button>
    </div>
  </div>

  <script>
    let ws;
    let username;

    // Default theme
    document.documentElement.style.setProperty("--primary", "#667eea");

    function changeTheme() {
      const theme = document.getElementById("themeSelector").value;
      document.querySelector(".chat-header").style.background = theme;
      document.querySelectorAll(".msg.you").forEach(el => el.style.background = theme);
      document.querySelectorAll(".input-area button, .file-upload button, #loginArea button")
        .forEach(el => el.style.background = theme);
    }

    function connect() {
      username = document.getElementById("username").value;
      if (!username) {
        alert("Please enter your name!");
        return;
      }

      ws = new WebSocket(`ws://127.0.0.1:4000/ws/${username}`);

      ws.onopen = () => {
        document.getElementById("loginArea").style.display = "none";
        document.getElementById("messageArea").style.display = "flex";
        document.getElementById("fileArea").style.display = "flex";
        document.getElementById("currentUser").textContent = `You: ${username}`;
        appendSystemMessage("✅ Connected to chat.");
      };

      ws.onmessage = (event) => {
        const msg = event.data;
        if (msg.startsWith("📂")) {
          const parts = msg.split(":");
          const sender = parts[0].replace("📂 New file uploaded by ", "").trim();
          const fileInfo = msg.substring(msg.indexOf(":") + 1).trim();
          const filename = fileInfo.split("(")[0].trim();
          const url = fileInfo.match(/\/files\/\S+/)[0];
          appendFileMessage(sender, filename, url, sender === username ? "you" : "other");
        } else {
          const [sender, text] = msg.split(": ");
          appendMessage(sender, text, sender === username ? "you" : "other");
        }
      };

      ws.onclose = () => {
        appendSystemMessage("❌ Disconnected.");
      };
    }

    function sendMessage() {
      const msg = document.getElementById("message").value;
      if (msg && ws) {
        ws.send(msg);
        appendMessage("You", msg, "you");
        document.getElementById("message").value = "";
      }
    }

    function sendFile() {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select a file!");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      fetch("http://127.0.0.1:4000/upload_and_notify", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        appendFileMessage("You", data.filename, data.url, "you");
      });

      fileInput.value = "";
    }

    function appendMessage(sender, text, type) {
      const chatBox = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = `msg ${type}`;
      div.innerHTML = `<b>${sender}</b> ${text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendFileMessage(sender, filename, url, type) {
      const chatBox = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = `msg ${type}`;
      div.innerHTML = `
        <b>${sender}</b>
        📂 ${filename}
        <div class="file-actions">
          <a class="file-link" href="${url}" target="_blank">View</a>
          <button class="download-btn" onclick="downloadFile('${url}', '${filename}')">Download</button>
        </div>
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendSystemMessage(text) {
      const chatBox = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "msg other";
      div.innerHTML = `<i>${text}</i>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function downloadFile(url, filename) {
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>